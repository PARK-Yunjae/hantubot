# Hantubot 이메일 알림 설정 가이드

## 개요
Hantubot의 CRITICAL 로그, 주문 실패, 프로그램 크래시 등 중요 이벤트를 이메일로 받는 설정 가이드입니다.

**수신 이메일**: dbswoql0712@gmail.com

---

## Gmail 앱 비밀번호 생성

### 사전 요구사항
- Gmail 계정 (발송용)
- 2단계 인증 활성화 필요

### 1단계: 2단계 인증 활성화
1. Google 계정 설정: https://myaccount.google.com/
2. **"보안"** 메뉴 클릭
3. **"Google에 로그인"** 섹션에서 **"2단계 인증"** 클릭
4. 설정 단계 따라 진행 (휴대폰 인증)

### 2단계: 앱 비밀번호 생성
1. Google 계정 설정 → **"보안"**
2. **"Google에 로그인"** 섹션
3. **"앱 비밀번호"** 클릭 (2단계 인증 활성화 필요)
4. **"앱 선택"** → **"기타(맞춤 이름)"**
5. 이름 입력: `Hantubot`
6. **"생성"** 클릭
7. **16자리 앱 비밀번호** 복사 (예: `abcd efgh ijkl mnop`)
8. ⚠️ 이 비밀번호는 다시 볼 수 없으므로 안전하게 보관

### 3단계: .env 파일에 추가
```bash
# configs/.env 파일 편집
EMAIL_ENABLED=true
EMAIL_SMTP_SERVER=smtp.gmail.com
EMAIL_SMTP_PORT=587
EMAIL_SENDER=your_email@gmail.com
EMAIL_PASSWORD=abcdefghijklmnop  # 16자리 앱 비밀번호 (공백 제거)
EMAIL_RECEIVER=dbswoql0712@gmail.com
```

---

## 이메일 알림 트리거

### 1. CRITICAL 로그
**발생 시점**: 프로그램 크래시, 치명적 오류
**내용**:
- 오류 메시지
- 스택 트레이스
- 발생 시각

### 2. 주문 실패 (5회 연속)
**발생 시점**: 주문 API 호출 5회 연속 실패
**내용**:
- 종목 코드 및 종목명
- 실패 사유
- 재시도 횟수

### 3. API 토큰 갱신 실패
**발생 시점**: 한국투자증권 API 토큰 갱신 실패
**내용**:
- API 응답 코드
- 오류 메시지
- 토큰 만료 시각

### 4. 포트폴리오 이상
**발생 시점**:
- 손실률 -10% 초과
- 잔고 불일치 (API vs 로컬)
**내용**:
- 현재 잔고
- 손익률
- 보유 종목 목록

### 5. 시스템 재시작
**발생 시점**: 자동 재시작 로직 실행
**내용**:
- 재시작 사유
- 크래시 로그 요약

---

## 이메일 템플릿

### CRITICAL 알림
```
제목: 🚨 [Hantubot] CRITICAL: 프로그램 크래시

내용:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚨 CRITICAL ERROR 발생
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

발생 시각: 2025-12-26 14:35:22
오류 유형: UnexpectedError

오류 메시지:
[상세 오류 메시지]

스택 트레이스:
[스택 트레이스 내용]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Hantubot 자동매매 시스템
로그 확인: logs/hantubot_root_2025-12-26.log
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 주문 실패 알림
```
제목: ⚠️ [Hantubot] 주문 실패 (5회 연속)

내용:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ 주문 실패 (5회 연속)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

종목: 삼성전자 (005930)
주문 유형: 매수
수량: 10주
가격: 75,000원

실패 사유:
[API 오류 메시지]

재시도 횟수: 5/5
마지막 시도: 2025-12-26 09:15:33

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
수동 확인 필요
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 포트폴리오 이상 알림
```
제목: ⚠️ [Hantubot] 포트폴리오 이상 (-15.3%)

내용:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ 포트폴리오 손실률 경고
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

현재 잔고: 93,170원
초기 잔고: 110,000원
손익률: -15.3%

보유 종목:
- 000000 종목A: -12.5% (5주)
- 111111 종목B: -18.2% (3주)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
포트폴리오 점검 권장
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 테스트 방법

### 1. 이메일 전송 테스트
```python
# hantubot/utils/email_alert.py 테스트
python -c "from hantubot.utils.email_alert import send_test_email; send_test_email()"
```

### 2. CRITICAL 로그 테스트
```python
# 테스트 스크립트 (test_email.py)
import logging
from hantubot.reporting.logger import get_logger

logger = get_logger("test")
logger.critical("이메일 알림 테스트")
```

### 3. Gmail 수신 확인
1. dbswoql0712@gmail.com 로그인
2. 받은편지함 확인
3. 스팸함 확인 (처음에는 스팸으로 분류될 수 있음)
4. 스팸 아님 처리 및 발신자 신뢰 추가

---

## 보안 고려사항

### ⚠️ 중요
1. **앱 비밀번호는 절대 GitHub에 커밋하지 마세요**
   - `.gitignore`에 `configs/.env` 포함 확인
2. **주기적으로 앱 비밀번호 변경**
   - 3개월마다 재생성 권장
3. **발송 계정 전용 사용**
   - 개인 주계정 사용 지양
   - Hantubot 전용 Gmail 계정 생성 권장

### Gmail 계정 생성 (선택사항)
1. 새 Gmail 계정 생성: hantubot.alerts@gmail.com
2. 2단계 인증 활성화
3. 앱 비밀번호 생성
4. `.env` 파일 업데이트

---

## Rate Limiting

### Gmail SMTP 제한
- **일일 전송 한도**: 500통
- **시간당 한도**: 100통
- **분당 한도**: 20통

### Hantubot 자체 제한
```python
# utils/email_alert.py
MAX_EMAILS_PER_HOUR = 10  # 시간당 최대 10통
MAX_EMAILS_PER_DAY = 50   # 일일 최대 50통
```

### 중복 방지
- 동일 오류 10분 내 재발송 차단
- CRITICAL 오류는 즉시 발송 (중복 방지 없음)

---

## 대안: Discord 웹훅 (권장)

### 장점
- 무제한 전송
- 실시간 알림
- 리치 포맷 (Embed) 지원
- 별도 계정 설정 불필요

### 단점
- Discord 앱 설치 필요
- 이메일보다 즉시성 낮음 (모바일 알림)

### 설정
```bash
# configs/.env
DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/...
```

---

## 트러블슈팅

### 문제 1: 이메일이 발송되지 않음
**원인**: SMTP 인증 실패
**해결**:
1. 앱 비밀번호 재확인 (공백 제거)
2. 2단계 인증 활성화 확인
3. Google "보안 수준이 낮은 앱" 설정 (비권장)

### 문제 2: 스팸함으로 분류됨
**원인**: Gmail 필터
**해결**:
1. 받은 이메일 → **"스팸 아님"** 처리
2. 발신자를 연락처에 추가
3. 필터 규칙 생성:
   - 조건: `from:(your_email@gmail.com)`
   - 동작: `받은편지함으로 이동`, `중요 표시`

### 문제 3: 인증 오류 (535 5.7.8)
**원인**: 앱 비밀번호 잘못 입력
**해결**:
1. 앱 비밀번호 재생성
2. `.env` 파일 업데이트
3. **16자리 그대로 입력** (공백 없이)

### 문제 4: 타임아웃 (연결 실패)
**원인**: 방화벽 또는 포트 차단
**해결**:
1. 포트 587 (TLS) 확인
2. 방화벽 예외 추가
3. 대안 포트 465 (SSL) 시도

---

## Email vs Discord 비교

| 항목 | Email | Discord |
|------|-------|---------|
| **즉시성** | ⭐⭐⭐ (1-5분 지연) | ⭐⭐⭐⭐⭐ (즉시) |
| **전송 한도** | 500/일 | 무제한 |
| **리치 포맷** | ❌ (텍스트만) | ✅ (Embed) |
| **모바일 알림** | ✅ | ✅ |
| **설정 난이도** | ⭐⭐⭐ (앱 비밀번호) | ⭐ (웹훅 URL만) |
| **보안** | ⭐⭐⭐ (SMTP 인증) | ⭐⭐⭐⭐ (웹훅 URL) |

### 권장 구성
- **CRITICAL 오류**: Email + Discord (이중 발송)
- **일반 알림**: Discord만
- **일일 요약**: Email

---

## 체크리스트

### 초기 설정
- [ ] Gmail 2단계 인증 활성화
- [ ] 앱 비밀번호 생성
- [ ] `.env` 파일에 설정 추가
- [ ] 테스트 이메일 전송 성공
- [ ] 수신 확인 (받은편지함 또는 스팸함)

### 주간 점검
- [ ] 이메일 수신 정상 확인
- [ ] 스팸함 체크
- [ ] 발송 한도 확인 (500/일)

### 월간 점검
- [ ] 앱 비밀번호 유효성 확인
- [ ] 발송 로그 분석 (불필요한 알림 제거)
- [ ] Gmail 저장용량 확인

---

## 관련 문서
- `AUTO_BOOT_SETUP.md` - 자동 부팅 설정
- `DEPLOYMENT_GUIDE.md` - GCP 배포 가이드
- `configs/.env.example` - 환경 변수 예시

---

## 작성일
2025-12-26

## 작성자
Hantubot 최적화 작업
