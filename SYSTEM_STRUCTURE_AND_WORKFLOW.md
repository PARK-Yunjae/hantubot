# Hantubot 시스템 구조 및 동작 검증 보고서

## 1. 파일 구조 및 역할 (File Structure & Roles)

`hantubot_prod`의 핵심 파일들의 역할은 다음과 같습니다.

### **최상위 실행 파일**
*   **`run.py`**: 프로그램의 진입점(Entry Point). 중복 실행 방지(Lock File), 자동 재시작(Crash Handler), GUI(`main_window`) 실행을 담당합니다.
*   **`configs/config.yaml`**: 봇의 모든 설정(API 키, 전략 파라미터, 시간 설정 등)을 담고 있는 파일입니다.

### **Core (핵심 엔진)**
*   **`hantubot/core/engine.py`**: 봇의 **심장**.
    *   **역할**: 장 운영 시간 관리(08:50 기상, 09:00 시작, 15:30 종료), 전략 실행 스케줄링, 데이터 수집 및 배포, 장 마감 후 작업 실행.
    *   **주요 로직**: `run_trading_loop`에서 무한 루프를 돌며 매 틱(기본 1분)마다 시장 상태를 체크하고 전략을 실행합니다.
*   **`hantubot/core/clock.py`**: 시장 시간 관리자. 휴장일(holidays 라이브러리), 장 시작/종료 시간, 동시호가 시간 등을 판단합니다.
*   **`hantubot/core/portfolio.py`**: 계좌 상태 관리자. 현재 현금, 보유 주식(Positions), 미체결 주문 등을 관리합니다.
*   **`hantubot/core/regime_manager.py`**: 시장 상황(Regime) 판단. 현재 시장이 상승장인지 하락장인지 판단하여 전략에 정보를 제공합니다.

### **Execution (매매 실행)**
*   **`hantubot/execution/broker.py`**: 증권사(한국투자증권) API와의 통신을 담당하는 창구. 시세 조회, 주문 전송, 잔고 조회 등의 기능을 수행합니다. (모의투자/실전투자 모드 전환 처리)
*   **`hantubot/execution/order_manager.py`**: 주문 관리자.
    *   **역할**: 전략에서 생성된 매매 신호를 검증(예산 초과, 중복 주문 방지)하고 실제 주문을 집행합니다.
    *   **안전장치**: 매도 주문 실패 시 3회 재시도, 실패 시 긴급 알림 발송.

### **Strategies (매매 전략)**
*   **`hantubot/strategies/opening_breakout_strategy.py` (1전략)**: 09:00~09:15 시초가 돌파 전략.
*   **`hantubot/strategies/volume_spike_strategy.py` (2전략)**: 장중 거래량 급증 단타 전략.
*   **`hantubot/strategies/closing_price/` (3전략)**: 15:00~15:20 종가 베팅 전략 (리팩토링 완료).

### **Study (유목민 공부법)**
*   **`hantubot/study/manager.py`**: 장 마감 후 데이터 수집, 뉴스 요약, 리포트 생성 작업을 총괄하는 오케스트레이터입니다.

---

## 2. 실행 흐름 및 시나리오 검증 (Workflow Verification)

### Q1. `run.py` 실행 시 어떤 작업을 거치는가?
1.  **초기화**: `run.py` 실행 -> 중복 실행 방지(Lock) -> `hantubot/gui/main_window.py` 로드.
2.  **GUI 실행**: `MainWindow`가 뜨고, 내부적으로 `EngineWorker` 쓰레드 생성.
3.  **엔진 시작**: `TradingEngine` 인스턴스 생성 -> `broker`, `portfolio`, `strategies` 로드 및 초기화.
4.  **메인 루프 (`engine.py`) 진입**: `run_trading_loop()` 시작.

### Q2. 날짜 및 시간별 대응 (거래일/비거래일/장전/장중)
*   **비거래일**: `MarketClock`이 휴장일임을 판단 -> 다음 거래일 08:50까지 `sleep` (대기 모드).
*   **거래일 08:50 이전**: 08:50에 기상하도록 설정되어 있음. 08:50에 깨어나서 초기화 작업을 수행하고 09:00까지 대기합니다.
*   **09:00 (장 시작)**:
    *   **감시 시작**: 09:00 정각부터 루프가 활성화됩니다.
    *   **무조건 매도**: `_process_market_open_logic()` 함수가 실행되어, **보유 중인 모든 포지션을 시초가(시장가)로 매도**합니다. (전일 종가매매 종목 청산)

### Q3. 매매 로직 안전장치 (건너뛰기/실패/미체결)
*   **함수 건너뛰기**: `OrderManager`에서 `_is_duplicate_signal` 함수가 있어, 60초 이내에 동일한 종목/방향의 주문 신호가 오면 무시합니다 (중복 주문 방지).
*   **매매 실패 대비**:
    *   `OrderManager`는 예산 부족, API 오류 등을 체크합니다.
    *   특히 **매도 주문**은 실패 시 **최대 3회 재시도**하며, 최종 실패 시 디스코드 **긴급 알림(Critical Alert)**을 보냅니다.
*   **미체결 확인**:
    *   `TradingEngine._poll_for_fills()`가 백그라운드에서 주기적으로(15초마다) 실행되어 체결 여부를 확인합니다.
    *   **[주의]**: 현재 **지정가 주문 미체결 시 자동 취소/정정 로직**은 명시적으로 구현되어 있지 않습니다. 다만 대부분의 전략이 **시장가(Market Order)**를 사용하므로 즉시 체결될 가능성이 높습니다.

### Q4. 전략별 강제 청산 (09:30, 15:00)
*   **로직 존재 여부**: `engine.py`의 `_check_forced_liquidation()` 함수에서 처리합니다.
*   **1전략 (Opening Breakout)**: 09:29부터 강제 청산 신호를 생성합니다.
*   **2전략 (Volume Spike)**: 14:58부터 강제 청산 신호를 생성합니다.
*   **무조건 매도**: 네, 해당 시간이 되면 조건 없이 시장가 매도 신호를 보냅니다.
*   **[개선 필요]**: 현재 "전략 종료 및 청산 완료"에 대한 **별도의 웹훅 알림 메시지**는 보내지 않고 로그만 남깁니다.

### Q5. 알림 및 로깅
*   **15:03 웹훅**: `ClosingPriceStrategy` (3전략)에서 15:03에 스크리닝 결과(TOP 3 종목)를 디스코드 웹훅으로 발송합니다.
*   **로그 기록**: 모든 동작은 `logs/` 디렉토리의 파일에 기록됩니다. 매매 내역은 별도의 `trades.jsonl` 파일에도 저장됩니다.
*   **전략 종료 보고**: 위에서 언급했듯이, 1전략/2전략 종료 시점에 "전략 종료"를 알리는 명시적인 웹훅 보고 기능은 현재 **없습니다.** (매도 체결 알림만 옴)

### Q6. 장 마감 후 프로세스 (학습 및 지각 대응)
*   **15:30 이후**: `_process_post_market_logic()`이 실행됩니다.
    1.  일일 리포트 생성 (`ReportGenerator`).
    2.  유목민 공부법 (`run_daily_study`) 실행: 데이터 수집 및 분석.
    3.  전략 최적화 (`run_daily_optimization`) 실행.
*   **지각 실행 (프로그램을 늦게 켠 경우)**:
    *   **16:30 이전**: 프로그램을 켜면 `engine.py`가 이를 감지하여 `run_daily_study`를 **강제 실행**합니다.
    *   **16:30 이후**: DB를 확인하여 오늘 날짜의 데이터가 없으면 실행합니다. 즉, **늦게 켜도 자동으로 수집**합니다.

---

## 3. 요약 및 개선 제안 (Recommendations)

전반적으로 시스템은 견고하게 설계되어 있으며, 사용자분이 우려하신 대부분의 케이스(지각 실행, 중복 방지, 강제 청산 등)에 대응되어 있습니다.

하지만 **완벽한 운영을 위해 다음 2가지 사항을 보완하는 것을 추천**합니다:

1.  **전략 종료 알림 추가**:
    *   09:30, 15:00에 강제 청산 로직이 돌 때, **"1전략 종료 및 잔여 물량 청산 완료"** 같은 요약 메시지를 웹훅으로 보내도록 개선하면 모니터링이 훨씬 편해집니다.
2.  **미체결 주문 취소 로직 명시화**:
    *   시장가 주문이라도 간혹 미체결이 남을 수 있습니다. 장 마감(15:30) 직전이나 전략 종료 시점에 **미체결 주문(Open Orders)을 전량 취소(Cancel All)**하는 로직을 추가하면 더 안전합니다.
